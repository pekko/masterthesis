% Lines starting with a percent sign (%) are comments. LaTeX will 
% not process those lines. Similarly, everything after a percent 
% sign in a line is considered a comment. To produce a percent sign
% in the output, write \% (backslash followed by the percent sign). 
% ==================================================================
% Usage instructions:
% ------------------------------------------------------------------
% The file is heavily commented so that you know what the various
% commands do. Feel free to remove any comments you don't need from
% your own copy. When redistributing the example thesis file, please
% retain all the comments for the benefit of other thesis writers! 
% ==================================================================
% Compilation instructions: 
% ------------------------------------------------------------------
% Use pdflatex to compile! Input images are expected as PDF files.
% Example compilation:
% ------------------------------------------------------------------
% > pdflatex thesis-example.tex
% > bibtex thesis-example
% > pdflatex thesis-example.tex
% > pdflatex thesis-example.tex
% ------------------------------------------------------------------
% You need to run pdflatex multiple times so that all the cross-references
% are fixed. pdflatex will tell you if you need to re-run it (a warning
% will be issued)  
% ------------------------------------------------------------------
% Compilation has been tested to work in ukk.cs.hut.fi and kosh.hut.fi
% - if you have problems of missing .sty -files, then the local LaTeX
% environment does not have all the required packages installed.
% For example, when compiling in vipunen.hut.fi, you get an error that
% tikz.sty is missing - in this case you must either compile somewhere
% else, or you cannot use TikZ graphics in your thesis and must therefore
% remove or comment out the tikz package and all the tikz definitions. 
% ------------------------------------------------------------------

% Document class for the thesis is report
% ------------------------------------------------------------------
% You can change this but do so at your own risk - it may break other things.
% Note that the option pdftext is used for pdflatex; there is no
% pdflatex option. 
% ------------------------------------------------------------------
\documentclass[12pt,a4paper,oneside,pdftex]{report}

% The input files (tex files) are encoded with the latin-1 encoding 
% (ISO-8859-1 works). Change the latin1-option if you use UTF8 
% (at some point LaTeX did not work with UTF8, but I'm not sure
% what the current situation is) 
\usepackage[latin1]{inputenc}
% OT1 font encoding seems to work better than T1. Check the rendered
% PDF file to see if the fonts are encoded properly as vectors (instead
% of rendered bitmaps). You can do this by zooming very close to any letter 
% - if the letter is shown pixelated, you should change this setting 
% (try commenting out the entire line, for example).  
\usepackage[OT1]{fontenc}
% The babel package provides hyphenating instructions for LaTeX. Give
% the languages you wish to use in your thesis as options to the babel
% package (as shown below). You can remove any language you are not
% going to use.
% Examples of valid language codes: english (or USenglish), british, 
% finnish, swedish; and so on.
\usepackage[finnish,english]{babel}


% Optional packages
% ------------------------------------------------------------------
% Select those packages that you need for your thesis. You may delete
% or comment the rest.

% Natbib allows you to select the format of the bibliography references.
% The first example uses numbered citations: 
\usepackage[square,sort&compress,numbers]{natbib}
% The second example uses author-year citations.
% If you use author-year citations, change the bibliography style (below); 
% acm style does not work with author-year citations.
% Also, you should use~\citet (cite in text) when you wish to refer
% to the author directly (\citet{blaablaa} said blaa blaa), and 
%~\citep when you wish to refer similarly than with numbered citations
% (It has been said that blaa blaa~\citep{blaablaa}).
% \usepackage[square]{natbib}

% The alltt package provides an all-teletype environment that acts
% like verbatim but you can use LaTeX commands in it. Uncomment if 
% you want to use this environment. 
% \usepackage{alltt}

% The eurosym package provides a euro symbol. Use with \euro{}
\usepackage{eurosym} 

% Verbatim provides a standard teletype environment that renderes
% the text exactly as written in the tex file. Useful for code
% snippets (although you can also use the listings package to get
% automatic code formatting). 
\usepackage{verbatim}

% The listing package provides automatic code formatting utilities
% so that you can copy-paste code examples and have them rendered
% nicely. See the package documentation for details.
% \usepackage{listings}

% The fancuvrb package provides fancier verbatim environments 
% (you can, for example, put borders around the verbatim text area
% and so on). See package for details.
% \usepackage{fancyvrb}

% Supertabular provides a tabular environment that can span multiple 
% pages. 
%\usepackage{supertabular}
% Longtable provides a tabular environment that can span multiple 
% pages. This is used in the example acronyms file. 
\usepackage{longtable}

% The fancyhdr package allows you to set your the page headers 
% manually, and allows you to add separator lines and so on. 
% Check the package documentation. 
% \usepackage{fancyhdr}

% Subfigure package allows you to use subfigures (i.e. many subfigures
% within one figure environment). These can have different labels and
% they are numbered automatically. Check the package documentation. 
\usepackage{subfigure}

% The titlesec package can be used to alter the look of the titles 
% of sections, chapters, and so on. This example uses the ``medium'' 
% package option which sets the titles to a medium size, making them
% a bit smaller than what is the default. You can fine-tune the 
% title fonts and sizes by using the package options. See the package
% documentation.
\usepackage[medium]{titlesec}

% The TikZ package allows you to create professional technical figures.
% The learning curve is quite steep, but it is definitely worth it if 
% you wish to have really good-looking technical figures. 
\usepackage{tikz}
% You also need to specify which TikZ libraries you use
\usetikzlibrary{positioning}
\usetikzlibrary{calc}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations.pathmorphing,decorations.markings}
\usetikzlibrary{shapes}
\usetikzlibrary{patterns}


% The aalto-thesis package provides typesetting instructions for the
% standard master's thesis parts (abstracts, front page, and so on)
% Load this package second-to-last, just before the hyperref package.
% Options that you can use: 
%   mydraft - renders the thesis in draft mode. 
%             Do not use for the final version. 
%   doublenumbering - [optional] number the first pages of the thesis
%                     with roman numerals (i, ii, iii, ...); and start
%                     arabic numbering (1, 2, 3, ...) only on the 
%                     first page of the first chapter
%   twoinstructors  - changes the title of instructors to plural form
%   twosupervisors  - changes the title of supervisors to plural form
% \usepackage[mydraft]{aalto-thesis}
\usepackage[mydraft,doublenumbering,twoinstructors]{aalto-thesis}
%\usepackage{aalto-thesis}


% Hyperref
% ------------------------------------------------------------------
% Hyperref creates links from URLs, for references, and creates a
% TOC in the PDF file.
% This package must be the last one you include, because it has
% compatibility issues with many other packages and it fixes
% those issues when it is loaded.   
\RequirePackage[pdftex]{hyperref}
% Setup hyperref so that links are clickable but do not look 
% different
\hypersetup{colorlinks=false,raiselinks=false,breaklinks=true}
\hypersetup{pdfborder={0 0 0}}
\hypersetup{bookmarksnumbered=true}
% The following line suggests the PDF reader that it should show the 
% first level of bookmarks opened in the hierarchical bookmark view. 
\hypersetup{bookmarksopen=true,bookmarksopenlevel=1}
% Hyperref can also set up the PDF metadata fields. These are
% set a bit later on, after the thesis setup.   


% Thesis setup
% ==================================================================
% Change these to fit your own thesis.
% \COMMAND always refers to the English version;
% \FCOMMAND refers to the Finnish version; and
% \SCOMMAND refers to the Swedish version.
% You may comment/remove those language variants that you do not use
% (but then you must not include the abstracts for that language)
% ------------------------------------------------------------------
% If you do not find the command for a text that is shown in the cover page or
% in the abstract texts, check the aalto-thesis.sty file and locate the text
% from there. 
% All the texts are configured in language-specific blocks (lots of commands
% that look like this: \renewcommand{\ATCITY}{Espoo}.
% You can just fix the texts there. Just remember to check all the language
% variants you use (they are all there in the same place). 
% ------------------------------------------------------------------
\newcommand{\TITLE}{Privacy Implications of Wireless\\ Network Probing}
\newcommand{\FTITLE}{Yksityisyydensuoja langattomissa verkoissa}
\newcommand{\SUBTITLE}{}
\newcommand{\FSUBTITLE}{}
\newcommand{\DATE}{August 5, 2014}
\newcommand{\FDATE}{5. elokuuta 2014}

% Supervisors and instructors
% ------------------------------------------------------------------
% If you have two supervisors, write both names here, separate them with a 
% double-backslash
% Also remember to add the package option ``twosupervisors'' or
% ``twoinstructors'' to the aalto-thesis package so that the titles are in
% plural.

\newcommand{\SUPERVISOR}{Professor Tuomas Aura}
\newcommand{\FSUPERVISOR}{Professori Tuomas Aura}

\newcommand{\INSTRUCTOR}{Professor Christopher Kruegel\\ Professor Giovanni Vigna}
\newcommand{\FINSTRUCTOR}{Professori Christopher Kruegel\\Professori Giovanni Vigna}

\newcommand{\COVERSUPERVISOR}{Professor Tuomas Aura, Aalto University}
\newcommand{\COVERINSTRUCTOR}{Professor Christopher Kruegel, University of California, Santa Barbara\\Professor Giovanni Vigna, University of California, Santa Barbara}


% Other stuff
% ------------------------------------------------------------------
\newcommand{\PROFESSORSHIP}{Data Communication Software}
\newcommand{\FPROFESSORSHIP}{Tietoliikenneohjelmistot}

% Professorship code is the same in all languages
\newcommand{\PROFCODE}{T-110}
\newcommand{\KEYWORDS}{}
\newcommand{\FKEYWORDS}{}

\newcommand{\LANGUAGE}{English}
\newcommand{\FLANGUAGE}{Englanti}

% Author is the same for all languages
\newcommand{\AUTHOR}{Pekko Lipsanen}


% Currently the English versions are used for the PDF file metadata
% Set the PDF title
\hypersetup{pdftitle={\TITLE\ \SUBTITLE}}
% Set the PDF author
\hypersetup{pdfauthor={\AUTHOR}}
% Set the PDF keywords
\hypersetup{pdfkeywords={\KEYWORDS}}
% Set the PDF subject
\hypersetup{pdfsubject={Master's Thesis}}


% Layout settings
% ------------------------------------------------------------------

% Use this to control how much space there is between each line of text.
% 1 is normal (no extra space), 1.3 is about one-half more space, and
% 1.6 is about double line spacing.  
% \linespread{1} % This is the default
% \linespread{1.3}

% Bibliography style
% acm style gives you a basic reference style. It works only with numbered
% references.
% \bibliographystyle{acm}
% Plainnat is a plain style that works with both numbered and name citations.
\bibliographystyle{plainnat}


% Extra hyphenation settings
% ------------------------------------------------------------------
% You can list here all the files that are not hyphenated correctly.
% You can provide many \hyphenation commands and/or separate each word
% with a space inside a single command. Put hyphens in the places where
% a word can be hyphenated.
% Note that (by default) LaTeX will not hyphenate words that already
% have a hyphen in them (for example, if you write ``structure-modification 
% operation'', the word structure-modification will never be hyphenated).
% You need a special package to hyphenate those words.
% \hyphenation{di-gi-taa-li-sta yksi-suun-tai-sta}


% The preamble ends here, and the document begins. 
% Place all formatting commands and such before this line.
% ------------------------------------------------------------------
\begin{document}
% This command adds a PDF bookmark to the cover page. You may leave
% it out if you don't like it...
\pdfbookmark[0]{Cover page}{bookmark.0.cover}
% This command is defined in aalto-thesis.sty. It controls the page 
% numbering based on whether the doublenumbering option is specified
\startcoverpage

% Cover page
% ------------------------------------------------------------------
% Options: finnish, english, and swedish
% These control in which language the cover-page information is shown
\coverpage{english}


% Abstracts
% ------------------------------------------------------------------
% Include an abstract in the language that the thesis is written in,
% and if your native language is Finnish or Swedish, one in that language.

% Abstract in English
% ------------------------------------------------------------------
\thesisabstract{english}{

}

% Abstract in Finnish
% ------------------------------------------------------------------
\thesisabstract{finnish}{

}

% Acknowledgements
% ------------------------------------------------------------------
% Select the language you use in your acknowledgements
\selectlanguage{english}

% Uncomment this line if you wish acknoledgements to appear in the 
% table of contents
%\addcontentsline{toc}{chapter}{Acknowledgements}

% The star means that the chapter isn't numbered and does not 
% show up in the TOC
\chapter*{Acknowledgements}

aalto, eurecom s3/nops, ucsb, speksi, WiGLE, everyone

\vskip 10mm

\noindent Espoo, \DATE
\vskip 5mm
\noindent\AUTHOR

% Acronyms
% ------------------------------------------------------------------
% Use \cleardoublepage so that IF two-sided printing is used 
% (which is not often for masters theses), then the pages will still
% start correctly on the right-hand side.
\cleardoublepage
% Example acronyms are placed in a separate file, acronyms.tex
\input{acronyms}

% Table of contents
% ------------------------------------------------------------------
\cleardoublepage
% This command adds a PDF bookmark that links to the contents.
% You can use \addcontentsline{} as well, but that also adds contents
% entry to the table of contents, which is kind of redundant.
% The text ``Contents'' is shown in the PDF bookmark. 
\pdfbookmark[0]{Contents}{bookmark.0.contents}
\tableofcontents

% List of tables
% ------------------------------------------------------------------
% You only need a list of tables for your thesis if you have very 
% many tables. If you do, uncomment the following two lines.
% \cleardoublepage
% \listoftables

% Table of figures
% ------------------------------------------------------------------
% You only need a list of figures for your thesis if you have very 
% many figures. If you do, uncomment the following two lines.
% \cleardoublepage
% \listoffigures

% The following label is used for counting the prelude pages
\label{pages-prelude}
\cleardoublepage

%%%%%%%%%%%%%%%%% The main content starts here %%%%%%%%%%%%%%%%%%%%%
% ------------------------------------------------------------------
% This command is defined in aalto-thesis.sty. It controls the page 
% numbering based on whether the doublenumbering option is specified
\startfirstchapter

% Add headings to pages (the chapter title is shown)
\pagestyle{headings}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Introduction}
\label{chapter:intro}

Wireless technology has been established well in everyday life. Most of the people have nowadays their own wireless network at home, and they use another at school or at work. When traveling, hotels and airports almost always offer Wi-Fis, in many cases for free of charge. Wireless networks can also be found in shopping malls, restaurants, and even in buses and trains -- and the number of networks is only growing.

From the very nature of wireless networks, transferred data is always visible to everyone who is inside the range of the network. Compared to traditional on-wire networking, this creates worries for information security. Lots of work has been done in order to make sure that actual transferred information, for example the content of web pages browsed, remains confident and is not visible for eavesdroppers. Such work includes, for example, standards for wireless network encryption.

However, we are interested in data exchange that happens before a device joins a wireless network. The device has not established any connections yet, so all the information is sent in plaintext, unencrypted, in public. This information includes at least the identifier of the device trying to connect to a network, and the network name it is trying to connect. Or, alternatively, the device can ask for information about all the networks in the range.

Manufacturers want to provide best possible user experience to their customers. A part of the experience is the ability to find a wireless network in the device's range, and to join fast to the network. Because of this, many devices scan continuosly the airspace and try to find out if there are networks to join. An understandable goal means that devices might leak out data about users: the names of networks user would like to join.


\section{Scope}
\label{sec:scope}

In this thesis, we try to examine what information can be extracted from the said part of data transmission, and how it can be used. Particular use cases include gathering information from passive monitoring and combining it with other dataset, for which we conduct a practical experiment. Together with that, we look for theoretical possibilities for active attacks exploiting mobile device's features.

We will also examine legal position of doing above-mentioned acts, and we are not limited to technical side of the issue. In addition, we will look for technical countermeasures for found privacy and security threats: how the techniques we found can be circumvented, if someone wants to. 

In the thesis, we do not take into account any other parts of data transmission. Especially outside the scope is traffic after connecting to network, such as user visiting web pages or reading his email.

For legal side, we do not try to give a worldwide detailed view. Instead, we focus on two major players, the United States and the European Union.

\section{Organization of thesis}

The thesis is organized as follows. In Chapter~\ref{chapter:protocol}, we tell how the 802.11 protocol, also known as Wi-Fi, works. We will see some importatnt parts of protocol in detail. In Chapter~\ref{chapter:profiling} we will examine how and why parts of wireless network protocols can be used for tracking and profiling users. Further, in Chapter~\ref{chapter:attacks} we will see how these features can be used in conducting active attacks and not only passive monitoring of devices. 

In Chapter~\ref{chapter:legal} we study the legal status of discussed methods. Practical experiment of above-mentioned techniques is conducted in Chapter~\ref{chapter:practical}, and in Chapter~\ref{chapter:countermeasures} we will see how privacy-concerned users could be protected from the actions we have studied. Finally, in Chapter~\ref{chapter:conclusion} we conclude the thesis.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{The 802.11 wireless network protocol}
\label{chapter:protocol}


Wireless connections can be divided into two categories. First, we have cell-based technologies, which are used between mobile network operator (such as Verizon, T-Mobile) and a mobile device. Such technologies include but are not limited to GPS, GPRS, EDGE, and UMTS. This thesis does not study these protocols.

We will examine the protocols and data transmissions used inside local area networks (LAN). Traditionally, those networks have been created by connecting cables between computers and a hub, a switch, or a router. Recently these local networks have been built with wireless connections, as they obviously allow users a great mobility. Also, as smartphones have developed with new mobile apps requiring more and more bandwidth, local area networks are easier and cheaper to build and use than mobile networks.

The protocol for wireless LAN (WLAN) is maintained by the IEEE LAN/MAN Standards Committee, also known as IEEE 802. The family of protocols covering WLAN is called the 802.11 family, and it includes many different versions of the standard, denoted by letters. Widely implemented standards of the family are 802.11b, 802.11g, and 802.11n.~\cite{IEEE802.11}


\section{Wireless networks terminology}
\label{sec:terminology}

Inside a wireless network there can be found several different devices. In the following, we will categorize them.

IEEE, a standards organization maintaining the wireless standard, defines all the devices capable to connect wireless network as \emph{stations} (STA). However, this definition is a bit too broad, so we will split it further.

First there can be found devices only connecting to an existing network, which we will call \emph{nodes}. A node can be any kind of device, and most common and most relevant ones for this study are laptops and smartphones. Other possible terms for node can be \emph{client} or \emph{terminal}.

Second, the devices building the wireless network and allowing nodes to connect to it are called \emph{Access points} (AP). A wireless network can consist of one or more APs.

Access points and nodes connected to them form a network, which can also be called \emph{Basic Service Set} (BSS). In this thesis, we refer to that simply as \emph{wireless network} or shortly as \emph{network}, if there is no room for confusion. Another term for connecting, used by the IEEE, is for nodes to \emph{associate} with an AP.

Nodes can also work in \emph{ad-hoc} mode, where they act simultaneously as an access point and as a node without well-defined structure. However, these networks are not common, and we will not cover them in this thesis.


\section{MAC Address}
\label{sec:MAC}

Every device in the network, wired and wireless, has a media access control (MAC) address. A MAC address is bound to a specific device and does not change while connecting to different networks, being reconfigured, restarted, or anything else. It should also be globally unique: the idea is that any two devices could join the same network without problems, and since the network needs to be able to differentiate between devices, every device must have a unique identifier.~\cite{802_overview}

A MAC address is 48 bits long and consists of two independent 24-bit parts. The first part specifies the manufacturer of the device, and that part is assigned by IEEE. This first part is called Organizationally Unique Identifier, or OUI.

The second 24-bit part can be freely chosen by the manufacturer, but it should be unique for each device. 

The real address space of OUI, the organization part of address, is 22 bits, because one of the 24 bits (the least significant) depends on application, and another (next to LSB) is always set to zero. Therefore there is space for $2^{22}$ organizations, which is a bit over four million. Because the second part is 24-bit, each organization can produce $2^{24}$ devices, which is more than 16 million. If this limit is exceeded, IEEE can give the organization another OUI. For example, Apple has more than 300 OUIs assigned.~\cite{oui_listing} However, IEEE states that it will not assign an organization multiple OUIs without proper reasons, and says that, ``in no way should these addresses be used for purposes that would lead to skipping large numbers of them''.~\cite{802_overview} 

MAC addresses are presented in a hexadecimal notation consisting of six octets, separated by a colon or a dash, for example \texttt{54:26:96:d0:2c:b1}. A graphical representation of a MAC address is shown in Figure~\ref{fig:mac}, where the first row is a raw binary representation, and the second row shows hexadecimal values. The last row shows separation between Organizationally Unique Identifier and the part that remains to be determined by the manufacturer.

\begin{figure}
\label{fig:mac}
\begin{tabular}{ |c|c|c | c|c|c | }
  \hline
  1010100 & 100110 & 10010110 & 11010000 & 101100 & 10110001 \\
  \hline
  54 & 26 & 96 & d0 & 2c & b1 \\
  \hline
  \multicolumn{3}{|c|}{Organizationally Unique Identifier} & \multicolumn{3}{c|}{Organization-controlled part} \\
  \hline
\end{tabular}
\caption{Structure of MAC address \texttt{54:26:96:d0:2c:b1}}
\end{figure}


\section{Service Set Identifier (SSID)}
\label{sec:SSID}

As we found in the last section, each device in a network has a unique identifier, a MAC address. If there are multiple APs available for a node to connect to, the node can identify and select the one by AP's MAC address.

However, such action usually requires human interaction: someone has to tell the node which one of the APs is the correct one. Using only MAC address is not convenient, since twelve-character hexadecimal representation does not resemble anything familiar or memorizable.

Also, physical network devices do not necessarily correspond to logical networks. There can be a wireless network in a university, where APs are being upgraded to new ones. Therefore the logical network is still the same in the same building for the same purpose, but all the MAC addresses of the APs have been changed: remember, every MAC address is globally unique.

To solve the problem, there is a concept of SSID, \emph{Service Set Identifier}. APs are given a human-readable string, the SSID, which has maximum length of 32 characters. This can be thought as a name of the network.

With SSID there is an abstraction of logical network over a physical one. Using the same example as before, if the university's wireless network keeps the same SSID, its APs can be updated without any problems: nodes will still find the correct network, even if the hardware is completely different and MAC addresses do not match anymore.

Network can also consist of more than one APs sharing the same SSID. This way, a wireless network can cover a huge building or even a larger area. When configured in such way, the network is said to be an \emph{Extended Service Set} (ESS).~\cite{IEEE802.11}

\subsection{Basic Service Set Identifier (BSSID)}

As we learnt previously, a network is called officially as Basic Service Set (BSS). To identify that uniquely, a Basic Service Set Identifier (BSSID) is used. 

If there is only single access point in the network, BSSID is the same as AP's MAC address. 

In ESS mode with multiple access points, every AP has still its own BSSID, but the whole network under a SSID needs a unique identifier. This is called ESSID, Extended Service Set Identifier.


\section{Packets}
\label{sec:packets_format}

In IEEE 802.11 standard~\cite{IEEE802.11}, there are many different packets, frames and fields for different purposes. In this study, we will look for the ones used when trying to join a network. We will not study physical layer requirements and specifications.

The standard calls a single entity of different data as a \emph{frame}. Each MAC frame -- which we are interested in -- contains

\begin{enumerate}
    \item A MAC header, containing metadata of the frame;
    \item A frame body, including the actual payload; and
    \item A checksum, called FCS.
\end{enumerate}

\subsection{General MAC frame format}

General format for MAC frames is presented on Figure~\ref{fig:general_mac_frame}. The frame consists of minimum of four and maximum of eleven fields, which are marked as ``mandatory'' or ``optional''. Decision of whtether or not optional fields are included is not left for implementation: it depends on which type of frame it actually is. MAC header includes all the fields except frame body and checksum.

The frame begins with a frame control field, which includes protocol version, type and subtype of the actual frame and specific flags for data transmission. The protocol version is currently zero. Type can be zero for management frames, one for control frames, or two for data frames. Value three is reserved for future use. Management frames will be studied in Section~\ref{subsec:management_frames}, but control frames and data frames are left outside of this thesis. Basically, management frames are higher-level frames that set up and maintain the connection. Control frames help handling delivery of data, and data frames include the data.

The flags in the frame control field specify, for example, whether the data transmitted has been split into fragments, or if this frame has already tried to be sent but failed, and this one is a retransmission of a failed one.

As much as four different address fields are included can be included in a MAC frame. Their purpose depends on frame type, and can include source address, destination address, or routing-type of information in ad-hoc network.

Another fields in MAC frame include sequence control, quality of service (QoS), and high-throughput (HT) control fields. We will not study these fields more.

\begin{figure}
    \label{fig:general_mac_frame}
    \begin{tabular}{|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{0.8cm}|}
    
        \multicolumn{9}{|c|}{MAC header} &
        \multicolumn{2}{c|}{ } \\
    \hline 
        Frame Control &
        Dura-tion/ ID &
        Addr. 1 &
        Addr. 2 &
        Addr. 3 &
        Seq. Control &
        Addr. 4 &
        QoS Control &
        HT Control &
        Frame Body &
        FCS \\
    \hline 
        \multicolumn{3}{|c|}{Mandatory} &
        \multicolumn{7}{c|}{Optional} &
        Man. \\

    \end{tabular}

    \caption{General MAC frame format}
\end{figure}


\subsection{Management frames}
\label{subsec:management_frames}

Management frames help to set up and maintain connection, that is, they carry metadata. A general view of management frame format is shown in Figure~\ref{fig:management_frame}, which resembles closely general MAC frame format from Figure~\ref{fig:general_mac_frame}. This is not an accident, because management frames are one type of MAC frames: they have \texttt{type} subfield in frame control field set as zero.

Management frames can be further divided into different frames depending of \texttt{subtype} field in frame control field. There are 15 different possibilities, and we will look for two of them: beacon frame and probe request frames.

\begin{figure}
    \label{fig:management_frame}
    \begin{tabular}{|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|p{1cm}|}
    
        \multicolumn{7}{|c|}{MAC header} &
        \multicolumn{2}{c|}{ } \\
    \hline 
        Frame Control &
        Dura-tion &
        Addr. 1 &
        Addr. 2 &
        Addr. 3 &
        Seq. Control &
        HT Control &
        Frame Body &
        FCS \\
    \hline 
        \multicolumn{6}{|c|}{Mandatory} &
        \multicolumn{2}{c|}{Optional} &
        Man. \\

    \end{tabular}

    \caption{Management frame format}
\end{figure}

\subsubsection{Beacon frame format}
\label{subsubsec:beacon_frame}

APs sent Beacon frames to advertise their own existence. They are defined to be a management frame with \texttt{subtype} of value 8, so identifying rule is \texttt{type == 0 and subtype == 8}.

The body of a Beacon frame is huge, containing total of 55 different field plus vendor-specific ones. We do not list them all here. The most important is the fourth field, \texttt{SSID}, which was presented in Section~\ref{sec:SSID}. Another important is the second field in frame body, \texttt{Beacon interval}, which represents the number of time units between beacon tramissions.


\subsubsection{Probe Request frame format}
\label{subsubsec:probe_request}

Probe Request frames are used to join a network as specified in the next section, in Section~\ref{sec:joining}.

Probe Request frame is a management frame with \texttt{subtype == 4}. Therefore it can be identified from all MAC frames by specifying criteria \texttt{type == 0 and subtype == 4}. 

All the fields in Probe Request frame are shown in Figure~\ref{fig:probe_request}. For us, the most important one is the first one, \texttt{SSID}, which was studied in detail in Section~\ref{sec:SSID}. Here we note that the maximum length of SSID is 32 bytes, and it can contain UTF-8-encoded characters, if Extended Capabilities field (9th in Probe Request frame body) contains specific UTF-8 flag set to one.

In addition to single SSID field, there is a field called \texttt{SSID List}, tenth in order, where one can specify multiple SSIDs it is interested in. The field includes a subfield to note the length of the list. The length subfield has a size of one octet, so there can be at most 255 different SSIDs.

In the last field, vendor can specify its own extensions.

\begin{figure}
\center
\label{fig:probe_request}
\begin{tabular}{|c|l|}
    \hline
    Order & Field \\ \hline
    \hline
    1 & SSID \\ \hline
    2 & Supported rates \\ \hline
    3 & Request information \\ \hline
    4 & Extended Support Rates \\ \hline
    5 & DSSS Parameter Set \\ \hline
    6 & Supported Operating Classes \\ \hline
    7 & HT Capabilities \\ \hline
    8 & 20/40 BSS coexistence \\ \hline
    9 & Extended Capabilities \\ \hline
    10 & SSID List \\ \hline
    11 & Channel Usage \\ \hline
    12 & Interworking \\ \hline
    13 & Mesh ID \\ \hline
    Last & Vendor-specific extensions \\ \hline
\end{tabular}
\caption{Probe Request frame body}
\end{figure}

\section{Joining a network}
\label{sec:joining}

So far we have characterized different elements of a wireless network. In this section, we will discuss how a node can find an existing wireless network. This can be achieved using either (1) active scanning or (2) passive scanning, which both are defined in the IEEE standard.~\cite{IEEE802.11_scanning}

\subsection{Passive scanning}
\label{subsec:passive_scanning}

In passive scanning, a node does not send anything by itself in order to find the network it wants to join. Instead, a node listens the transmissions, and scans for beacon frames sent by APs.

As we have learnt previously in Section~\ref{subsubsec:beacon_frame}, beacon frames include an SSID, and in Section~\ref{sec:SSID}, SSID identifies particular network and acts as a human-understandable network name. Therefore the node can display the networks it found to end-user, who makes the decision which network to join. Alternatively, node can compare its findings to previously generated list of known networks, and join one it finds familiar.

Passive scanning has some drawbacks. First, it might be relatively slow, as a node needs to wait for APs to broadcast their beacons. Second, it is possible to configure AP so that it does not broadcast its SSID: this feature is called \emph{Hidden SSID}. Therefore, a node using passive scanning does not see APs using Hidden SSIDs --- it can only join them by using AP's MAC address.

\subsection{Active scanning}
\label{subsec:active_scanning}

In active scanning, the situation is different. This time a node knows beforehand which network it would like to join, and sends \emph{probe request frames} into the air. Construction of probe request frames was discussed in Section~\ref{subsubsec:probe_request}.

The standard does not specify time interval between scanning of different rounds of scanning, and every manufacturer can decide that on their own.  

\subsection{Active scanning with a wildcard SSID}
\label{subsec:active_wildcard}

There exists also a combination of active and passive scanning. A node can request information of all present wireless networks by sending a probe request frame with wildcard SSID. When an AP sees a wildcard probe request, it replies to the node with its own SSID. This way, the node does not state which networks it knows or want to join, but it also does not need to wait APs to advertise themselves by beacon frames. 

IEEE Standard states wildcard SSID to be the one with all bits set to zero. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Profiling and tracking}
\label{chapter:profiling}

\section{Customer profiling and tracking}
\label{sec:profiling}

Before beginning, we will define what profiling means. First, Oxford English dictionary defines the term as:~\cite{oed_profiling}

\begin{quote}
The recording, itemization, or analysis of a person's known psychological, intellectual, and behavioral characteristics, esp. as documentation used (in schools, businesses, etc.) in the assessment of an individual's capabilities; (also) the compilation of databases which store such information and that can be used to identify any particular subgroup of people.
\end{quote}

A little more relevant definition for this study could be one written by Hilberdant:~\cite{hildebrandt2008}

\begin{quote}
The process of ``discovering'' correlations between data in databases that can be used to identify and represent a human or nonhuman subject (individual or group), and/or the application of profiles (sets of correlated data) to individuate and represent a subject or to identify a subject as a member of a group or category.
\end{quote}

In this thesis, we are interested in profiling in a sense of discovering some characteristics of a person from collected data. As mentioned in both of definitions above, we are not limited to profiling single persons, but may also look for particular groups of people, if they have interesting properties in common.

For example, it might be useful to know how old the customers are on average or if they are interested in different product ranges or visit a store different times of a day. An interesting - yet difficult to provide - property would be customer's wealth or willingness to pay more. If seller could detect this kind of people, it could easily improve its revenue and profits by promoting more expensive deals to those ones.

\textbf{Tracking} is easier to define. We use it to mean situation where one follows another person's movements or actions, directly or by following a device owned by tracked person. 

Tracking and profiling in themselves do not produce any income. However, information generated by them can be used to design new marketing campaigns and strategies, adjust prices, or otherwise promote sales.

An example of price variation based on customer profiling can be found in experiment made by Deck and Wilson (2006)~\cite{Deck2006}. In the research, they divided customers into two categories based on their search history. The first group is called ``informed customers'', who have been searching for prices also from other stores. On the other hand, the second group of users is called ``uninformed'', who do not know about the general prices of a product. The results of experiment shows that with tracking, informed customers are given lower prices, whereas ignorance of uninformed customers can be exploited with higher prices.

On the Internet it is easy to profile users of a webpage. In a study by Pakkala et al.~\cite{Pakkala2012504} researchers try to analyze what kind of people are using food composition websites in three different countries. They used Google Analytics~\cite{googleanalytics}, a free tool available to everyone, to collect visitor statistics (also other similar tools are available, with or without a charge). By looking referential websites, usage patterns, and search terms they were able to conduct that, for example, most of the users were not food or nutrition professionals, but average people looking for basic information about nutrition. In the study, researchers conclude that ``web analytics should be routine for every website [..] making user behaviour clearer so that developers can produce better websites for users.''

For the physical, brick-and-mortar type of stores, achieving this kind of information is much more difficult. They can conduct customer studies by using surveys, but such a study requires lots of resources and might not be trustworthy because of response bias~\cite{Furnham1986385}: it may be totally different what people say than how they really act. Also, where it is extremely easy to track all the actions customers take while shopping on an online store, gathering the same data in traditional store using traditional methods can be close to impossible. Therefore it is easy to see that online stores have a clear competitive advantage over brick-and-mortar ones -- and the latters are interested in to neglect that.

Some solutions before the establishment of WLAN devices have been proposed. An interesting one is work done by Newman, Yu and Oulton (2002) in~\cite{Newman2002253}, where they use existing CCTV surveillance cameras in a store to automatically track customers' movements. An example of their system is presented on Picture~\ref{fig:cctv_tracking}, where on the left one can see paths that customers have walked. Same kind of work is done by Senior et al.~\cite{senior2007video}, and in recent years there have been commercial solutions available~\cite{retailcctv}.

\begin{figure}
    \label{fig:cctv_tracking}
    \includegraphics[width=\textwidth]{images/cctv_tracking_newman_pic1}
    \caption{Example of CCTV-based customer tracking from work by Newman et al~\cite{Newman2002253}}
\end{figure}


\section{Tracking using MAC address}
\label{sec:mac_tracking}

To see where a user has been and how he has moved, tracking system needs to be able to perform two operations. First, it needs to be able to determine the location of the device in question. Second, as the data is not continous but comes with single, discrete points, all the location data needs to be linked together. That is, a device needs to be assigned some form of a unique ID.

Wireless nodes send their MAC address with every probe request, as we learnt in Section~\ref{subsec:active_scanning}. The MAC address is also globally unique; see Section~\ref{sec:MAC}. Therefore the MAC address seems to be a good candidate for an ID, so we can continue towards a much harder problem, actually locating the nodes.

\subsection{Determining the location of a node}
\label{sec:location}

A na{\"i}ve yet robust way to approximate user's location would be to look which AP received node's probe request. In Picture~\ref{fig:position_1} an oversimplified situation is presented: there is a rectangular-shaped building with a room, a few shelves, and four access points. The APs are labeled with letters from A to D. The building is divided into four sections, and the position of a mobile device is determined by looking which AP received a request from it. For example, it might be assumed that only AP D receives a signal from the mobile device in the picture, and therefore the user is somewhere in the lower-right section of the building.

\begin{figure}
    \label{fig:position_1}
    \includegraphics{images/positioning_1.pdf}
    \caption{Simplest way to achieve positioning}
\end{figure}

However, things are obviously not that simple. In real-life situations, coverage of a single AP can be large and easily overlap with others, and signal from the mobile device in Picture~\ref{fig:position_1} could also be in the ranges of APs B and C. A real-life example from~\cite{xiang2004} is presented in Picture~\ref{fig:ibm_coverage}, where in Picture~\ref{subfig:ibm_layout} the layout of building is presented, and in Picture~\ref{subfig:ibm_strength} the strength of a signal from a single AP is shown. Note that the whole floor is covered by the AP at least in some amount, but there are still four more APs. This suggests that at least in this case, a device can always catch more than one signal.

\begin{figure}
\begin{center}
\subfigure[Layout of the building]{
  \includegraphics[scale=0.34]{images/ibm_wlan_layout.png}
  \label{subfig:ibm_layout}
}
\subfigure[Coverage of AP$_1$]{
  \includegraphics[scale=0.34]{images/ibm_wlan_strength.png}
  \label{subfig:ibm_strength}
}
\caption{A real-life example of WLAN coverage. Taken from~\cite{xiang2004}.}
\label{fig:ibm_coverage}
\end{center}
\end{figure}

Distance from a node to an AP can be estimated by using strength of radio signal. This cannot give the exact distance, as transmitting power varies between devices, and we do not know the initial power. However, this problem does not prevent us from using it as an estimate, because we are interested in relative distances. Continuing the simple way, we can select an AP that received the strongest signal; for a little more accurate result, a triangular-based calculation could be done with simple trigonometry, if at least three APs received the signal.

Luckily, lots of research has been done for creating WLAN-based positioning systems, and that research includes more and more sophisticated methods for determining the location. Xiang et al.~\cite{xiang2004} constructed a model of signal propagation, Roos et al.~\cite{roos2002} used probablistics and machine learning, and so on. Most of this research tries to let mobile phone determine its own location based on the signal from APs, but exactly the same approach can be used other way around, as we would like to: to let AP find out mobile node's position by node's signals.

\section{Profiling users using SSIDs from active scanning}
\label{sec:ssid_profiling}

Whereas previous section discussed on possibilities to track a device based on MAC address, in this chapter we will see how it is possible to profile users who have left active scanning running on their devices. Later we conduct a practical study based on techniques presented in this chapter; this is done in Chapter~\ref{chapter:practical}. 

First we assume that a profiler has set up a device that collects all the probe requests sent by other devices. After that, the profiler looks for SSIDs included in probe requests and tries to figure out some information about customers based on the SSID data.

\subsection{Geolocation}
\label{subsec:ssid_geo}

SSIDs do not necessarily leak any information about their location. In some cases that may be true: for example, an open network in Aalto University is called ``Aalto open'', or a public network at Los Angeles airport as ``LAX-WiFi'', but in general no such connection can be drawn.

Numerous applications would benefit from ability to connect wireless network APs to physical geolocation. For example, this could serve as a backup solution in lack of GPS signal for positioning, which is the case when user is inside a building. The same mapping other way around, mapping location to wireless access points, would allow mobile phone users to find a nearby open WLAN instead of consuming expensive cellular data transfer.

The solution for this problem is quite simple and straightforward. A collecting device goes around the world, capturing all the SSIDs and MAC addresses of WLANs it finds. Then, using GPS, it gets the location of network and stores data into simple database. Numerous companies have already done this: the best-known case might be Google, who did it with its Street View cars~\cite{google_wifi_collection}. 

Another way to get the data is to use crowdsourcing -- in other words, to let users do it themselves. In this way, every time a user connects to a new network, exact geolocation is saved with phone's GPS receiver. The location, SSID of the network, and probably more information such as signal strength are then saved into a database. Using this approach, data-collecting company can gather lots of data with relatively low expenses, and may be able to achieve higher accuracy compared to smaller dataset.

Both of above-explained applications for geolocation data of wireless networks have been implemented. Google uses WLAN locations with its Android operating system to provide location data based on networks it finds around~\cite{google_wifi_collection}. Nokia and Microsoft use same kind of data in Windows Phone in order to locate open WLANs near the user's own location~\cite{nokia_datasense}.

In addition to proprietary databases, there exists an open one called WiGLE, Wireless Geographic Logging Engine~\cite{wigle}. WiGLE has operated since 2001, and it provides almost 150 million unique Wi-Fi networks with location data (as in August 2014). WiGLE gets locations from users' submissions and gives data access for free. In itself, WiGLE is not suitable for large-scale analysis, because it does not provide full data dump and limits amount of queries one is able to perform daily. For this research, we have been temporarily granted higher limits.

It is important to note that the mapping from SSID to location is not one-to-one: multiple wireless networks around the world may share the same SSID. In fact, this is quite common, since many WLAN owners do not change the default SSID of their AP. In WiGLE, most common SSIDs are ``linksys'', ``NETGEAR'', and ``dlink'', which all are default SSIDs of different AP manufacturers.

Some useful information can be obtained from geolocated SSIDs. The easiest one is to try to guess where the users might live by figuring out where the majority of SSIDs are located. Not exact results can be got with this approach, but city-wide accuracy should be possible.

Another interesting factor is to determine how much a user has traveled: people with SSIDs around the world might behave in a different way than ones with SSIDs from only one country. 

We can develop this approach further by trying to identify concrete places user has visited, for example hotels, restaurants, and universities. Categorizing places is possible with combining data from multiple sources and datasets, for example Expedia Hotel Database~\cite{expedia_hotel_db} and Google Places~\cite{google_places}. Even more, Expedia provides some information of quality and price range of a hotel, which can also be used to characterize a user: does he tend to use high-quality services or likes to prefer low-price alternatives?

\subsection{Discovering real-life relationships from common SSIDs}
\label{subsec:ssid_commons}

After collecting much of SSIDs from lots of devices, it is possible to discover friendships based on which SSIDs people share with each other. A paper on this approach has been written by Cunche et al.~\cite{cunche2014linking}

In the paper, they have two datasets: one collected from small number of volunteers with known friendships, and another from the wild, which has been collected over a six-month period in Sydney, Australia. The dataset of volunteers contained strong relationships, such as close friends and family members. Authors created a model based on observations of the known dataset and applied it to unknown data from the public.

Finding strongly connected nodes in two datasets has been studied well in computer science, so there are numerous mathematical models developed for this particular problem. Cunche et al. measure performance for many of those and develop them forward to match the specific characteristic of SSIDs. These include a long tail of popularity, which means that some SSIDs are extremely popular, but there are a lot of those with only a couple of hits. In the paper, they argue that finding common SSIDs that appear rarely in the whole dataset is a strong signal of relationship. 

Probably the biggest problem for finding relationships in dataset is that it is computationally heavy. Complexity is $O(N^2)$ where $N$ is the number of devices in a dataset, so it may be impractical to try to find all the links in a large dataset, such as Cunche's six months long range of data. Nonetheless, if we are limited to small population, for example people visiting a specific place, a store, or an airport during a day, it might be perfectly feasible to calculate all the possible combinations.

Real-life use cases to benefit from such a findings can also be found. If we are not limited only to strong connections, such as family members, weaker connections can suggest that users share some charasteristics. After having categorized users in different clusters, one could try to look if the clusters are distinguishable from each others. For example, does the one group look like younger people, and do they visit the store on specific time of the day, or spend notably more or less time in the shop?

\subsection{Social media networks}
\label{subsec:social_media}

A novel and interesting approach is to combine SSID data with social media. In this section we will present the idea, and in Chapter~\ref{chapter:practical} we will perform practical experiment to see if the idea can be implemented with our resources.

The key idea and goal of our research is to find the owner of a device from social media based on SSID findings. Possible social media platforms include Facebook, Twitter, Foursquare, Google+ and others. These include --- or at least provide a possibility to include --- a location data into a posting. 

Thus, we have three datasets. First, we have collection of SSIDs from target's device. Second, we have a mapping from SSID to geolocation. Third, we have a database of people's social media postings with their locations. By combining all of them, we may be able to reveal the social media profile used by the device user.

From the social media service list above, Twitter can be considered the most public. By default, every \emph{tweet}, a post to Twitter, is visible to everyone, whereas in Facebook the default audience is limited to user's friend network. For this reason, we will study primarly Twitter, but other networks share the same idea, if private access to the database is granted.

Twitter provides a free-of-charge Application programming interface (API) to its data.~\cite{twitterapi} Using the API, one can fetch tweets with or without specific search criteria. One possible method to limit the results is by location coordinates.

As a drawback, searching by geolocation is limited to 180 requests in an hour. Also, only recent tweets are available. Nevertheless, the idea does not suffer from these limitations, as we should assume that a private API or future development will allow access to larger amount of data.


\subsection{Semantic SSID analysis}

Semantic SSID analysis is a technique where we try to profile a user based on the content of information retrieved from SSIDs. This is a technique that is obviously possible to some extent, but to our knowledge no studies have acutally tried to implement it.

We see at least the following possibilities:\\

\textbf{Identify students and other academic people.} Universities usually have their own wireless networks, individual ones or common \emph{eduroam} in Europe, so they are easy to spot.

\textbf{How much is a user traveling?} Identify airports and hotels. Categorize user to different price categories based on hotel's average price level. Probably same kind of information can be extracted from restaurants' and cafes' names.

\textbf{}



\section{Other information obtained from probe requests}
\label{sec:other_info}

We are able to find even more information from probe requests than we have discovered so far. As discussed in Section~\ref{sec:MAC}, first half of a MAC address, Organizationally Unique Identifier (OUI), is determined by manufacturing company. When comparing that to a database containing all the OUIs assigned, we will be able to discover the manufacturer of a node. The database is available for free~\cite{oui_listing}.

In~\cite{pang2007802}, Pang et al. have been trying to fingerprint WLAN users by different traffic characteristics. The methods they used were (1) network destinations, (2) SSID probes, (3) broadcast packet sizes, and (4) MAC protocol fields. 

However, their approach was different from ours, as they study a scenario where analyzer can monitor all the traffic: the user has connected to a wireless network run by analyzer. In our work, we are limited to the probing phase, which happens before any connection has been made. This limitation rules the first method, examining network destinations, out. Also, SSID probes are already covered elsewhere in this work.

Broadcast packet sizes are a possible approach. Some services and applications broadcast information or advertisements about themselves. For example, Dropbox, a cloud-storage service provider, has a desktop app that tries to find computers with linked Dropbox accounts in the local network. If they were found, transferring data between them would be a lot faster and cheaper than via public internet.~\cite{dropboxlan} All the content of broadcasts are encrypted in secure WLANs, but broadcasted packets can still be found, because they are sent to a known broadcast MAC address \texttt{ff:ff:ff:ff:ff:ff}. MAC address is always sent in plaintext. The size of the packets is also unencrypted, which leaves the possibility to retrieve information even from encrypted networks.

The last method, MAC protocol fields, tries to exploit the fact that MAC header includes flags and fields that vary between different manufacturers and configurations. As Pang et al. themselves note, this is usually not enough to distinguish users uniquely, because quite a many people use exactly the same model of a device. However, this method can be used in addition to others, if necessary.

It should be noted that both of these methods are not likely to work in our case. Broadcast packets are sent only when user has already joined a network, and we are studying the situation where user is still probing for available alternatives. MAC protocol fields are only a small piece of information, and those fields do not differentiate devices enough.

\subsection{Wi-Fi Protected Setup}
\label{sec:wps}

Another exploitable feature is Wi-Fi Protected Setup (WPS). The technology is used to ease the setup of a secure, consumer-grade wireless network. Using WPS, users do not need to know about technical details or enter complex passwords to gain access to WLAN, but instead can push a button on both AP and their mobile device. There are also another ways to implement the standard, including entering PIN code or using NFC-capable device.~\cite{alliance2007wi}

The actual standard for WPS is available without a charge only for Wi-Fi Alliance members~\cite{alliance2007wi}, but we do not consider that as a constructive way to develop technical standards. Therefore we resort to reverse engineering the standard using packet analyzing tool called Wireshark~\cite{wireshark}, which has implemented the WPS protocol. Wireshark is open source software, so the protocol can be analyzed with an effort low enough by reading source code and running analysis on captured packets. Also, there are other documents freely available to gather information about the protocol, such as Microsoft's technical specification for WPS inside their own document~\cite{microsoftWCN}.

In the protocol there are three actors: enrollee, AP and registrar. Enrollee is simply a user willing to join a wireless network using WPS. Registrar is the authority who will gain or deny access. AP is the same access point as previously, but this time it is specified to act as a link between enrollee and registrar. In practice, and in especially in consumer-grade devices, registrar's functionality is often included in AP. 

\begin{figure}
\label{tab:wps}
\begin{tabular}{c|c p{10cm}}
    \hline

    E $\rightarrow$ R & M1 = & N$_E$, Description, PK$_E$ \\\\

    &  & Below this every message includes a HMAC of current and previous messages \\
    \hline \\

    E $\leftarrow$ R & M2 = & N$_E$, N$_R$, Description, PK$_R$ \\\\

    &  & Below this every message includes other party's nonce \\
    \hline \\

    E $\rightarrow$ R & M3 = & Password hashed \\\\

    E $\leftarrow$ R & M4 = & Password hashed, 1st half of secret nonce encrypted \\\\

    E $\rightarrow$ R & M5 = & 1st half of secret nonce encrypted \\\\

    E $\leftarrow$ R & M6 = & 2nd half of secret nonce encrypted \\\\

    E $\rightarrow$ R & M7 = & 2nd half of secret nonce encrypted, encrypted configuration data \\\\

    E $\leftarrow$ R & M8 = & Encrypted configuration data \\
    \hline
\end{tabular}
\caption{Protocol for joining a WPS-enabled WLAN. Simplified from~\cite{microsoftWCN}}, detailed version in Appendix~\ref{chapter:appendix:wps}
\end{figure}

Because joining a WPS-enabled network has been wanted to make easy but secure for end-users, it is somewhat complex in technical side. Simplified version of protocol is shown in Figure~\ref{tab:wps}, and detailed version can be found in Appendix~\ref{chapter:appendix:wps}. Basically, first enrollee sends its nonce, its own description and its public key to registrar, and registrar replies with the same kind of message with its own information. Then, in messages 3 and 4, parties make precommitments that they know the password by sending it in hashed form. In messages 4-7, parties send their own secret, encrypted hashes, which can be used with previously-sent hashes to make sure that the password was correct. Finally, in message 8, registrar sends WLAN configuration data including credentials to join the WLAN.

The most important and interesting part for us is in the very beginning, since we are interested in probe requests. We found that some devices are actively sending WPS requests hoping that an AP would reply. This request is the same as message 1 in the protocol, and it is sent in a probe request frame's last field, targeted for vendor-specific information.

In message 1, there is a broadly-named field ``Description''. The data it includes makes it worth to look closer. Microsoft's document says that it is ``[a] human-readable description of the sending device (UUID, manufacturer, model number, MAC address, and so on) and device capabilities such as supported algorithms, I/O channels, and Registration Protocol role.'', and Wireshark confirms exactly that. Also, there is a field called ``DEVICE\_NAME'', which is the human-readable name user has given to his device, for example ``Pekko's iPhone''.

With all this information, we may be able to
\begin{enumerate}
    \item categorize users by their phone manufacturer and model,
    \item identify a node with UUID in addition to MAC address, and
    \item possibly extract private information from user, for example user's real name from device's name
\end{enumerate}


% this may be left out
% \section{Evaluation of current mobile devices}
% \label{subsec:evaluation}
% iphone, android, WP
% do they broadcast all the ssids or just a wildcard?
% order? SEE THE SOURCE CODE!


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Active man-in-the-middle attacks}
\label{chapter:attacks}

In addition to passive surveillance, there is possibility for performing active attacks against users. In active attacks, the attacker does not only monitor user's behavior, but instead sends malicious packets to perform desired activities. 

All the following attacks are some variants of man-in-the-middle (MITM) scheme. In MITM attack, the attacker positions himself between user and the service user is connecting to. This way, an attacker is able to read and alter all unencrypted communication while remaining transparent for the victim. The following attacks differ by how an attacker gains such a position.

\section{Unencrypted access point}
\label{sec:attack_unencrypted}

The easiest attack is to set up an unencrypted access point and monitor all the traffic that goes through it. Obviously this is not very sophisticated, but at least some users are likely to be tricked into this one for various reasons.

First, they do not know or care about wireless network security but only see a free connection to internet to use. No technical security measure can save users, if they want to use an open connection with unknown administrator.

Second, multiple versions of Windows has a feature to join any unsecured wireless network in the range~\cite{dai2005attacking,windows_wifi_answers}. Therefore, user's computer can join an open network without user being aware of that. Even worse, with some versions of Intel wireless drivers, the setting to disable the automatically-connecting feature is hidden elsewhere than in unusual settings dialog.~\cite{windows_wifi_answers}

An unwanted connection can be damaging, even if the user realizes the mistake relatively fast and disconnects his computer from open network. Quite a many services want to synchronize their data right after connected; for example, an email client would like to get new messages immediately when the computer becomes online. Therefore it is certainly possible that user's credentials are sent during first moments in a new network.

\section{Evil twin}
\label{sec:evil_twin}

If there are multiple alternatives available, nodes have a couple of methods to decide which network they join. In Windows, there is a preferred wireless networks list, which specifies the order in which computer should connect to networks~\cite{windows_wifi_preferred}. 

If there is no preferred networks available, a node may choose the one which has strongest signal strength -- or if not choose, at least present it as a first alternative to user. Another methods have also been proposed, such as testing networks for their bandwidth and choosing the best~\cite{Nicholson:2006:APselection}. However, these kinds of advanced methods have not been implemented, so previously-selected networks and physical-layer signal strength are the most common criteria used nowadays.

\begin{figure}
    \begin{center}
    \subfigure[Normal scenario]{
      \includegraphics{images/evil_twin_normal.pdf}
      \label{subfig:evil_twin_normal}
    }
    \subfigure[Evil twin steals the connection with the same SSID]{
      \includegraphics{images/evil_twin_mitm.pdf}
      \label{subfig:evil_twin_mitm}
    }
    \caption{Evil twin attack}
    \label{fig:evil_twin}
    \end{center}
\end{figure}

The idea of Evil twin attack is presented in Figure~\ref{fig:evil_twin}. First, there is a normal scenario. A user is having a coffee in his favorite cafe, and joins cafe's open, unencrypted network which has an SSID \texttt{NiceCafe}. Everything goes well. The next time the same user is visiting the cafe again, but this time there is a malicious access point with the same SSID, \texttt{NiceCafe}. Remember, SSID is not a unique identifier, and it can be chosen freely. The malicious one is located closer to the user or has a more powerful antenna, so its signal is much stronger than the original AP's. Therefore, the user connects to malicious access point, and all the traffic is suddenly vulnerable.

\section{Man in the middle exploiting WLAN probes}
\label{sec:mitm_probes}

In previous section, an attacker knew beforehand that there was a specific network available and chose his SSID based on that. This is not necessary, and opens room for a more powerful attack.

A rogue access point can be listening for all the probes in the air. When it sees something, for example a node probing for a network \texttt{NiceCafe}, the AP can change its SSID to \texttt{NiceCafe} and let the node to connect.

If a node is not probing any specific SSID but asking all the nodes to broadcast theirs, the basic version of this attack will not obviously work. Still, there exists an opportunity: quite a many device has at one time connected to a network with an unchanged, manufacturer-default SSID, such as \texttt{Linksys} or \texttt{dlink}. According to WiGLE~\cite{wigle}, five most common SSIDs account for 4.2~\% of total SSIDs seen, and 100 most common SSIDs for 12.7~\% of total. An attacker could try all the common ones and hope that at least one of them is in node's SSID list.

\section{Encryption}
\label{sec:attack_encryption}

A particular problem for attackers is encryption. Wireless networks may be secured using techniques such as WPA2 (Wi-Fi Protected Access 2), which is based on a pre-shared secret -- a passphrase. Both parties of communication, client and AP, identify each other using four-way handshake, so the AP cannot only wait for client to send the correct passphrase. Since the attacker does not know the passphrase and it is not included anywhere in cleartext, WPA2 renders previous attack useless.

Another possible piece of encryption is Transport Layer Security, TLS (predecessor known as SSL, Secure Sockets Layer, and often these two are mixed). With a bit confusion with the name, it can be said that TLS is implemented between transport layer and application layer. As this layer is above link-layer, on which attacker operates, it should be a safe alternative.

However, there is a technique called sslstrip~\cite{marlinspike2009new}, which is designed specifically to redirect badly implemented TLS/SSL connections to unencrypted ones. At this time, using TLS can be considered only a partial solution against MITM attacks: the technique is safe only if used correctly, which is not always the case.

\section{Existing software and devices}

Concepts discussed here are not new, and for them there are specific tools implemented.

In previous section we mentioned technique called sslstrip; to prove its efficiency, authors decided to publish fully-working tool that implements the full attack.~\cite{marlinspike2009new}

Most comprehensive and most easy-to-obtain toolkit is WiFi Pineapple~\cite{wifipineapple}. It includes numerous tools for MITM and other attacks and sells for as low as \$~100 (as in August 2014).

With this kind of ready-made tools, performing man-in-the-middle attacks are totally feasible with only a little knowledge, and they must to be taken seriously.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Legal status}
\label{chapter:legal}

So far we have seen how it is possible to collect data from mobile devices, how to interpret the collected data, and how to perform active attacks exploiting features of said devices. In this chapter, we study the legal framework of the issue.

Most of the cases have basis on privacy legislation. Privacy is recognized internationally on the Universal Declaration of Human Rights \cite{udhr}, but actual laws are not universal but vary greatly between countries. Thus, we concentrate on two major players in the field, the United States and the European Union.

We will divide our study in three parts:
\begin{enumerate}
    \item Is collecting SSID data legal, or how is it regulated?
    \begin{enumerate}
        \item Collecting SSIDs from access points and mapping them
        \item Collecting SSIDs from mobile devices
    \end{enumerate}
    \item Is interpreting SSID data legal, or how is it regulated?
    \item Is performing active man-in-the-middle attacks legal?
\end{enumerate}

The best-known and best-documented legal case for two first questions is Google's Street view, on which we give small background information before beginning. After the study of current regulations, we will look for the ongoing development in the field.

% is there any legislation? terms and conditions -- can't apply, if the user hasn't joined a network

% approaches to get an ``I agree'' from customers: 
% (1) put a physical sign (case Nordstrom, Inc) 
% (2) use a specific app (case Helsinki-vantaa)
%     -> if an app requires Wi-Fi permissions (on android), it can look easily for all previous networks (there was a paper on that) \cite{2014_WISEC_Achara}

\section{Background of Google Street View case}
\label{sec:streetview}

The case with Google's Street View data collection has been a major case in regards of regulation of the topic, so we will first look on that. 

Steet View~\cite{googlestreetview} is Google's service built on their Maps platform. In Street View, one can view panorama photos taken from the streets. Google has collected the images by driving on streets with a car equipped with multiple cameras and a GPS device~\cite{streetview_behindscenes}.

Cars were collecting more information than only pictures of the streets. Google first told that they were collecting photos, WLAN network information including only access points' SSID and MAC address, and 3-D geometry data with lasers, all of them to help Google build location services. Google stated explicitly that it does not collect any payload information from wireless networks. \cite{fleischer_datacollected} However, that was proved false when German Data Protection Authority (DPA) wanted to audit the data, and Google admitted that it ``had mistakenly included code in our software that collected samples of payload data from WiFi networks''~\cite{eustace_datacollected}.

\section{European Union}
\label{sec:legal_europe}

Europe is a complex legal entity, as traditionally diverse countries are trying to harmonize their legislation inside the European Union. We concentrate on current status and forthcoming efforts of the EU and do not study minor differences or historical laws in European countries.

The EU can impose four different types of legislation:~\cite{lisbon_288}
\begin{description}
     \item[Regulation] becomes a law in every EU country without alterations.
     \item[Directive] is binding to every member state, but each of them will consider how to adopt it in the best way, taking into account the current laws.
     \item[Decisions] are binding but only to whom they are addressed.
     \item[Recommendations] are, as the name suggests, only opinions without binding force.
\end{description}

Legislation is created by the European Parliament, the Council of the European Union and the European Commission.~\cite{eu_institutions}

For privacy issues, there is European Data Protection Supervisor (EDPS), who works together with each state's Data Protection Authorities (DPA). With the European Commission, these institutions form \emph{Article 29 Working Party},~\cite{wp29_rules} which we will refer as \emph{Working Party}. The Working Party has only advisory status~\cite{wp29_rules}, but its opinions must be taken seriously, as it is in direct interaction with law-making institutes of the EU.

\subsection{Personal data}
\label{subsec:eu:personal_data}

According to the official opinion of the Working Party~\cite{wp29_185}, the relevant piece of legistation is the data protection directive (1995/46/EC)~\cite{data_protection}. It states in the first article for its object that

\begin{quote}
    In accordance with this Directive, Member States shall protect the fundamental rights and freedoms of natural persons, and in particular their right to privacy with respect to the processing of personal data.
\end{quote}

The question therefore is (1) is mapping of WLAN access points ``personal data'', and if yes, (2) what consequences does it have? Personal data is defined in Article 2(a) as

\begin{quote}
    any information relating to an identified or identifiable natural person ('data subject'); an identifiable person is one who can be identified, directly or indirectly, in particular by reference to an identification number or to one or more factors specific to his physical, physiological, mental, economic, cultural or social identity;
\end{quote}

Thus, the first requirement of personal data is that a person can be identified from the data. This interpreation is backed by opinion on personal data by the Working Party~\cite{wp29_136}. In the opinion, there is an example saying that ``Images of individuals captured by a video surveillance system can be personal data \textbf{to the extent that the individuals are recognizable}.'' (emphasis added)

To recognize only a possible group of people is not enough.~\cite{wp29_136} For example, only the last name of an individual is not personal data when talking about the whole population of a country, but within a school class, the last name is enough to identify a single person, and therefore personal data.

Together with previous observation, we can note that identifying a group from big mass is not personal data, but multiple such identifications in a combination can result in personal data. Using the same example, one cannot identify a people when given a class he studies in nor when given his last name, but in a combination, identification is possible.

\subsection{Collecting access point data}
\label{subsec:eu_collect}

To manage the problem, we face it in parts. First we look for the legal status of mapping WLAN access points. We assume that a service is collecting two different pieces of data: SSID and location.

To make it easier, we first examine only the SSID data. SSIDs are names for networks, decided by network administrators. Clearly SSIDs of public networks, such as in buses or schools, are not personal data. In private home networks they are difficult to categorize as personal data: in most of the cases, the SSID is the default (\texttt{linksys}) or arbitary name (\texttt{My little network}). Also, SSIDs are not unique, and there are lots of networks with the same name. The only possibility would be if someone named his network after his own name (\texttt{John Doe's network}). Therefore collecting only SSIDs should not be treated as personal data.

Combining the SSIDs with location data raises more questions. If we know the location of an access point, can we link it to specific individual? The first thing to note is that location data is only an approximation. The location of a collecting device is not the same as the location of access point, and in fact, even the location data of a collecting device may have errors. In rural areas where spaces between houses are large, it is possible to map a single access point to a specific house; in dense areas such as cities, this causes problems and at least requires significant amount of work.

However, there are a couple of cases where precise identification could be possible. We have examined that some SSIDs include the first name of a person, such as \texttt{John's home network}. Given with an approximate location, it might be possible to say ``within this building, there is only one John, so the network is his''. 

The question whether SSID-location-combination of data is personal data is therefore a question of reasonability of an event described above, and amount of work that is required to discover an individual: if identifying is theoretically possible, is it enough? The phrasign in the directive is the following~\cite{data_protection}:

\begin{quote}
    to determine whether a person is identifiable, account should be taken of all the means likely reasonably to be used either by the controller or by any other person to identify the said person
\end{quote}

This is a difficult question. The Working Party notes that not only today's situation is enough to consider, but that also future development should be taken into account, if data is to be stored for a longer period.~\cite{wp29_136} Because there have been no legal cases for the issue, we cannot answer this question reliably.

The Working Party has said in a different opinion~\cite{wp29_185} that 
\begin{quote}
    the combination of a MAC address of a WiFi access point with its calculated location, should be treated as personal data.
\end{quote}

However, in our case we had only a MAC address and an SSID, not the BSSID that would uniquely identify the access point uniquely. In an article written by Watts, Brunger, and Shires~\cite{watts2011european} argue that the practical likelihood of mapping an access point to an individual is extremily low, and therefore mapping of access points should not be treated as personal data, even when BSSID is collected. It is worth to note that the writers of previous article were assisting Google on its Street View case, so their opinion is likely to be in favor of Google and against regulation of such databases.

Together with data protection directive, there is another possible directive for the case, the e-privacy directive (2002/58/EC). However, it is not relevant for the case. First, in the opinion of the Working Party, it is said to apply only to location data processed by telecom operators~\cite{wp29_185}. That can be read from the directive, where ``location data'' is defined in Article 2(c) as

\begin{quote}
    location data means any data processed in an electronic communications network or by an electronic communications service, indicating the geographic position [..]
\end{quote} 

SSID data from nodes or access points is not processed in electronic communications network or service, as they refer to telecom operators. This directive is therefore designed to protect privacy of cell-location data from mobile phones.

\subsection{Collecting node data}

The legal view of collecting mobile devices' data is analyzed in the same way as collecting AP data. An important difference is that one device is highly linked to an individual, whereas many people may use the same access point.

Every mobile device has an MAC address, which is a unique identifier. By tracking the movements of a person based on MAC address, and combining it with, for example, a CCTV camera, one may reasonably be able to identify an individual. This kind of information should be treated as personal data.

Collecting SSID data is more difficult. In fact, our experiment in Chapter~\ref{chapter:practical} deals with this issue, as we try to show what kind of data can be extracted from SSIDs. Therefore the question wheteher SSIDs are considered as personal data depends highly on iterpretation of result like our study: is it considered reasonably enough? At least there is a possibility that SSID queries should be treated as personal data.

\subsection{Analyzing the data}

% case 1)
%     - wp29_opinion_185_en vs International Data Privacy Law-2011-Watts-149-60
%     - the original directive

% case 2)
%     - right to be forgotten
%     - see all data collected/created by profiling

\section{The United States}

% case 1)
%     - wiretapping act
%     - google vs joffe
%         - Mason_Joffe
%         - ninth-circuit-joffe

% case 2)
%     - ongoing: currently legal, but Consumer Privacy Bill of Rights will change
%     - Jennings_protect_consumer_privacy


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Practical study}
\label{chapter:practical}

In this chapter, we will conduct a practical experiment of previously discussed techniques and methods. We will look for general patterns in data, compare manufacuturers, and apply different profiling techniques to the data. 

\section{Methodology}
\label{sec:methods}

\subsection{Collecting SSID data}

SSID probe data was captured from various public locations in a range of 25 kilometeres (15 miles). We used a single Apple laptop with an internal wireless antenna and open-source software. No special or expensive equipment nor propertiary software was used, so anybody is able to perform same kind of data collection.

Location data was obtained from WiGLE~\cite{wigle}, where we were given higher query limits than for original users. For the other services we used, Google Places and Expedia, we had exactly the same privileges than normal user, and nothing was purchased for our research. Therefore the same kind of research can be done by anyone, and with commercial resources, its quality can probably be raised significantly.

\subsection{Twitter}

Twitter was a special case, since its API is pretty limited for rate. We collected Twitter's feed to our own servers and built our own database, so that we get an unlimited access to data, simulating private access. 

Twitter's API return results in JSON (JavaScript Object Notation) format. We preprocessed the data by removing all the tweets without location information; this was done with a simple \texttt{grep} filtering. After that, the data was imported into the database.

Our choice for database software was MongoDB~\cite{mongodb}, which is a high-performance NoSQL database. MongoDB is specifically designed to work with JSON format, so importing data was painless. 

The biggest problem with Twitter's data was its huge size. We were able to collect only 10~\% of continuous feed, which must have affected the results. Private access to Twitter's full database would probably have given better outcome.

\section{Overview of data}
\label{sec:data_overview}

$a$ probe requests, a1 with only broadcast

$b$ unique MAC addresses

$c$ SSIDs, popularity: most common ones found almost in every $n$th device, but $m \%$ were only in one (graph! long tail!)

on average $d$ ssids/probe req

$e$ WPS leaks

Everything by manufacturers (use OUIs); who leaked the most?

Twitter, a lot of everything...

\section{Commons}
\label{sec:practical_commons}

\section{Geolocation}
\label{sec:practical_geo}

\section{Semantic analysis}
\label{sec:practical_semantic}

\section{Social networks}
\label{sec:practical_social}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Countermeasures}
\label{chapter:countermeasures}

Not everyone is happy or confident with an idea that someone is tracking their movements or profiling their behavior. Together with legal view presented in Chapter~\ref{chapter:legal}, we will study technical countermeasures to prevent the usage of techniques discussed in this paper. 

\section{Countermeasures for MAC address tracking}

Tracking customers' movements based on MAC address is a relatively simply technique, as we have already seen. Tracker needs to be able to (1) locate a device, and (2) determine which location point is from which device. 

We cannot prevent anyone from locating a device that transmits signal on radio frequencies, so the only possible countermeasure is to negate possibility to match location points to a single device. Therefore a device must not broadcast MAC address or other information that uniquely identifies it.

WLAN standard offers no help, so there is a need for new solutions. Apple announced in June 2014 that in iOS 8, it will be randomizing the MAC address during wireless network scanning~\cite{FredericJacobs2014,apple_wwdc_privacy}. Randomized address would work as a \emph{pseudonym}, which identifies device for a specific request or for a limited time, but not universally.

As iOS 8 is not yet released, we cannot study its behavior in detail. However, randomization presents a couple of interesting questions. Normally, a device sends a bunch of probe requests almost at once and then sleeps for some period of time, usually between 30 to 60 seconds. A proper implementation requires that the MAC address is randomized after \emph{every} single probe request, not only between different cycles. Otherwise, tracker could identify device based on the broadcasted SSID list and completely ignore the MAC address.

We should look if there is enough space for randomizing a new MAC address for every probe request without collisions. Suppose that an average device has $N = 15$ (TODO CHECK) SSIDs on their preferred network list. By randomizing only organizationally-controlled part of MAC address -- leaving OUI untouched, respecting its purpose -- a single OUI block can provide about 16 million different addresses, and give enough space for $M \approx 10^6$ simultaneous devices. Due to birthday paradox, this number needs to be decreased down to $\sqrt{10^6} = 1000$ devices, which should still be enough for one network. Also, in reality Apple has multiple OUI blocks, not only one.

To be a working solution, it must not use too much resources. A device with randomized MAC address needs to save all the previous addresses in order to be able to filter replies targeted to it. Because number of different networks is really small, this will not be a pjroblem. Also, after a succesful connection or relatively short timeout (measured in seconds), a pseudonym can be forgotten. Some computational overhead will be generated from randomizing process, but that should be really small -- after all, we are only generating 24 or 48 bits.

Randomization can be more stealthy if the whole address is being randomized, including the OUI part. This way, tracker could not determine straight from MAC address which device it is. Spoofing such a field can be a double-edged sword: some services might rely on manufacturer identification and stop working after such a spoof. However, this is pretty unlikely. Randomization should happen only in scanning phase, and after joining a network, it will not change anymore.

A direct consequence of previous is that after joining a network, a device can be tracked again, since it sends packets with a non-volatile MAC address. The MAC is not secured against eavesdropping in encrypted wireless networks. The question that remains open is whether the device uses a fixed MAC for every session or continues with the last randomized one. Obviously, a randomized address for every session would be better for privacy.

A possible problem may be that the device is leaking other information where it can be identified. For example, the WPS protocol presented in Section~\ref{sec:wps} might leak new unique user identifier, which renders the whole defense meaningless.

Implementing MAC address randomization seems to be a promising countermeasure against tracking during the scanning phase, if implemented correctly. Joining a network removes the advantage of randomization.

TODO: pseudonyms are used somewhere in GMS standard

\section{Countermeasures for SSID profiling}
\label{sec:countermeasures_ssid}

SSID profiling depends on few factors. A profiler has to be able to \begin{enumerate}
    \item Record SSID probes,
    \item Identify which probes are sent from the same device, and
    \item Analyze them using various data sources.
\end{enumerate}

If we want to prevent an attacker from recording SSID probes, we must not send them at all. This can be done using passive scanning, specified in Section~\ref{subsec:passive_scanning}, or with active scanning with a wildcard SSID, discussed in Section~\ref{subsec:active_wildcard}.

Passive scanning may have performance problems, since a node needs to wait for APs to advertise themselves, instead of probing them. As manufacturers would like to give customers best possible user experience, and significant delays joining a network could result in worse experience, this may not be a feasible solution. Manufacturers could make this as a setting in the device to give users a fast experience initially, with option for privacy-concerned users to turn their device into passive scanning or wildcard mode.

With active scanning using wildcard SSID, an attacker cannot anymore eavesdrop SSIDs exchanged. However, it might be possible for a determined one to probe the client with many different alternative SSIDs and see which ones a node is willing to join. The scale of data transmission required will render this attack useless for profiling cases, but man-in-the-middle attack presented in Section~\ref{sec:mitm_probes} could probe a node with most common SSIDs --- it needs to match only one of them to perform attack.

Third way to limit exposure is to probe only networks that are physically near the node. This approach is briefly introduced in work by Kim et al.~\cite{kimposter}, where a node knows its own location and the location of APs it has connected previously. Therefore, the node can try to actively probe only APs that should be available, and passively listen for others' probes. 

This approach suffers from a couple of issues. First, it requires node to know its own location, which may take some time to resolve resulting worse user experience. Second, the requirement for location data forces user to keep his GPS on, which consumes battery -- an important constraint on mobile devices. Third, storing previous AP's location data on mobile device might cause new privacy issues for stolen device: an SSID-to-geolocation mapping is not anymore required, but a thief can easily see where user has visited. Fourth, if GPS is not available, which is the case indoors, they propose that node could determine its location by neighboring APs' signatures. This is not a very reliable way, and may lead to worse user experience, which prevents any manufacturer to implement the feature.

We can allow devices to transmit data but render it useless for eavesdroppers using cryptographic techniques. Research by Lindqvist et al.~\cite{lindqvist2009privacy} proposes a method for that by modifying protocol to join a wireless network. In their work, a client includes its nonce $N_{client}$ in a probe request. Then AP sends back client's nonce, its own nonce $N_{AP}$, and a random identifier that acts as an SSID for the connection, called R-SSID. The R-SSID is encrypted using shared key, and the key is generated from shared secret, network passphrase.

To negate the second requirement, identifying which probes are sent from the same device, we can use the same technique as in previous section, MAC address randomization. If the MAC address is randomized for every probe, the only thing a profiler sees is single requests from different MAC addresses. It would need to identify devices in some other way, so we need to be sure that no additional information is leaked --- just as discussed in previous section.

The third option, preventing analyzing, cannot be done in technical measures. TODO legal.


\section{Securing against active attacks}

In the following, we will look at how to secure against active man-in-the-middle attacks presented in Chapter~\ref{chapter:attacks}. 

Defense mechanisms can be categorized into two groups. In client-side defenses, mobile nodes take new security precautions to avoid connecting to rogue access point. In network administrator's defenses, the administrator of WLAN is trying to actively locate rogue access points in his own network. After detecting one, other non-techincal methods can be taken in order to remove the access point.

\subsection{Client-side defenses}

Man-in-the-middle attacks presented here require that user connects to a rogue access point. In the first case, an access point was open, which means that some operating systems will connect to it without user's consent. Obviously, this threat can be negated by turning such a feature off. 

In evil twin attack, the attacker has learnt a SSID of an existing access point and presents himself as with the same SSID. For this, a node could save each SSID with a BSSID, AP's MAC address. Therefore the node would detect that there is a different physical device with a different MAC address, and present two alternative ways to proceed:
\begin{enumerate}
    \item Try to search harder, wait a moment: maybe there is a legitimate AP available. If so, connect to it.
    \item If not, it is possible that network equipment has been upgraded, or the network spans over a larger physical area with lots of access points. In that case, a mobile device could present confirmation dialog to the user, asking if he really wants to connect to that network. This approach is present at least on Windows Mobile 8.
\end{enumerate}

Song et al.~\cite{song2010peeping} suggest that client could look for network hops. Their defense addresses the situation where there is an evil twin between the legitimate AP and the client. In other words, th evil twin is using the original WLAN for internet connectivity. When this is the case, the client could detect that in a network with two different APs with the same SSID, one has one hop more to the internet than another. Therefore, it can know that an extra hop is for MITM attack, and should not connect there.

Song's approach works well when their assumptions hold. It is reasonable to think that their use case is a realistic one, but one should not base full trust on it. First, with today's 3G connectivity, the evil twin may easily be connected to internet without utilising the original AP's internet connection. Second, the evil twin may be located somwhere else: for example, someone could setup a ``Starbucks WiFi'' where there is no Starbucks nearby, but quite a many may join the network since they have previously visited Starbucks.

To tackle the previous Starbucks scenario, Gonzales et al.~\cite{gonzales2010practical} propose two methods. First, they want to combine trust with location data: if the network is seen on a different place than initially, it may be evil. The location is determined by looking for other APs nearby: if too many of them have changed, the location is tought to be different. The second method requires protocol changes, as they propose that APs should be identified with public key cryptography. Keys would be self-signed without trusted third party, which means that initially there is \emph{no verified trust}, but all the later connections are guaranteed to be with the same AP as the first one. The approach is called \emph{trust-on-first-use}, and is used also in SSH protocol. Similiar kind of method is proposed by Bauer, Gonzales and McCoy~\cite{bauer2008mitigating}.

Often best solutions are simple. Consider the scenario when attacker is exploiting user's probe requests to guess a name of network user would be willing to connect to. Then the defense is straightforward: do not send probe requests with SSIDs, but resort to wildcard probing or passive scanning. A problem with passive scanning is that it may reduce performance, which manufacturers do not like to see. However, active scanning with wildcard SSID should be fast enough.

An attack for previous defense would be to guess few most used SSIDs and try to connect with them. Here saving a BSSID with an SSID would help: guessing a SSID from, say, out of twenty most common used ones is trivial, but going through the MAC address is not. Even if attacker would be limited to a couple of OUIs by guessing correclty the manufacturer, it has still 24-bit keyspace to discover, which is more than 16 million possibilities.

In a conclusion, there are lots of different approaches for defending user against evil twin attacks on the client side. None of them is perfect: some require changes to protocol which may be troublesome to deploy; some work only on some scenarios, and attackers knowning that limitation can easily change their way to attack. The best defense is achieved by combining many different approaches, and can be though as \emph{defense in depth} with many layers.

\subsection{Network administrator's defenses}

In addition to user's efforts, network administrators can try to detect rogue APs around their network. This field is much more mature in terms of commercial solutions than client's side, which may be due to the fact that it is easier to sell security solutions to techinical administrators than to poorly-educated consumers. Examples include most of big vendors in wireless and networking industry, such as Motorola~\cite{motorola_airdefense} and Cisco \cite{cisco_ips}. Unfortunately companies do not usually disclose the details of their implementations.

The first type of administrator-side defenses monitors waves on radio frequencies (RF) to find rogue APs. The idea behind this method is simple: there are only a known amount of wireless access points in known locations with known BSSIDs, and everything else is unauthorized. The method is therefore comparing a whitelist to scanning results. The scanning can be done my walking around with a laptop or installing probing devices around the building.~\cite{proxim_rogue_ap}

There are also solutions that combine access points with a probing device. Together with that, they may monitor the wired network and try to correlate the signals.~\cite{proxim_rogue_ap} If some data is seen only on wireless network but not on wired, it is clear that this AP is not set up by the administrator. If it tries to look legitimate, for example by having the same SSID, one can make a guess that it is a rogue AP.

Another possibility to detect rogue APs would be to measure round-trip time (RTT) to a known router inside the network as shown in~\cite{watkins2007passive}. The approach exploits the fact that time difference can be measured when packet travels through an extra hop. Thus, the last approach is actually the same as presented in previous section for user-side defenses to detect an extra hop, just with administrator's devices.

Both of these methods require network administrator to deploy his monitoring devices around the area network covers which can be expensive. To solve this particular problem, Bahl et al. from Microsoft propose~\cite{bahl2005dair} that in an office environment, existing desktop computers could have cheap wireless USB devices and use their spare CPU time to detect unknown APs. As desktop workstations are normally connected via wired network, the wireless USB would be available for only monitoring purposes.

\subsection{Conclusion of active attacks defenses}

In a conclusion, we can say that there are numerous types of users and threats. The ones a regular traveler may face are somewhat different from the ones a network administrator in a big company encounters, even though the basic idea and technology is pretty much the same.

No single silver bullet exist to mitigate all the threats. The best result is achieved with defense in depth by having multiple layers of defenses that complement each others. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Conclusion}
\label{chapter:conclusion}


% Load the bibliographic references
% ------------------------------------------------------------------
% You can use several .bib files:
% \bibliography{thesis_sources,ietf_sources}
\bibliography{sources}


% Appendices go here
% ------------------------------------------------------------------
% If you do not have appendices, comment out the following lines
\appendix
\chapter{WPS Protocol}
\label{chapter:appendix:wps}

The full protocol for Wi-Fi Protected Setup (WPS) is presented on Figure~\ref{tab:wps_full} and is taken from~\cite{microsoftWCN}. Notations are as follows:

\textbf{E}: Enrollee

\textbf{R}: Registrar

\textbf{Mi}: Message $i$

\textbf{Mi*} Message $i$ without HMAC value

\textbf{N$_E$, N$_R$}: Nonces generated by enrollee and registrar

\textbf{PK$_E$, PK$_R$}: Enrollee's and registrar's public keys

\textbf{ConfigData}: WLAN settings and credentials

\textbf{AuthKey}: Key derived with Diffie-Hellman, using N$_E$, N$_R$, and enrollee's MAC address

\textbf{E-Hash1, E-Hash2, R-Hash1, R-Hash2}: Hashed device passwords, first and second half

\textbf{E-S1, E-S2, R-S1, R-S2}: Secret, encrypted nonces, that can be used with respective hashes (E-S1 $\leftrightarrow$ E-Hash1) to confirm the knowledge of device password

\begin{figure}
\label{tab:wps_full}
\begin{tabular}{c|c p{10cm}}

E $\rightarrow$ R & M1 = & Version $\|$ N$_E$ $\|$ Description $\|$ PK$_E$ 
\\\\

E $\leftarrow$  R & M2 = & Version $\|$ N$_E$ $\|$ N$_R$ $\|$ Description $\|$ PK$_R$ [ $\|$ ConfigData ] $\|$ HMAC$_{AuthKey}$(M1 $\|$ M2*) 
\\\\

E $\rightarrow$ R & M3 = & Version $\|$ N$_R$ $\|$ E-Hash1 $\|$ E-Hash2 $\|$ HMAC$_{AuthKey}$(M2 $\|$ M3*) 
\\\\

E $\leftarrow$  R & M4 = & Version $\|$ N$_E$ $\|$ R-Hash1 $\|$ R-Hash2 $\|$ ENC$_{KeyWrapKey}$(R-S1) $\|$ HMAC$_{AuthKey}$ (M3 $\|$ M4*) 
\\\\

E $\rightarrow$ R & M5 = & Version $\|$ N$_R$ $\|$ ENC$_{KeyWrapKey}$(E-S1) $\|$ HMAC$_{AuthKey}$ (M4 $\|$ M5*) 
\\\\

E $\leftarrow$  R & M6 = & Version $\|$ N$_E$ $\|$ ENC$_{KeyWrapKey}$(R-S2) $\|$ HMAC$_{AuthKey}$ (M5 $\|$ M6*) 
\\\\

E $\rightarrow$ R & M7 = & Version $\|$ N$_R$ $\|$ ENC$_{KeyWrapKey}$(E-S2 [$\|$ConfigData]) $\|$ HMAC$_{AuthKey}$ (M6 $\|$ M7*) 
\\\\

E $\leftarrow$  R & M8 = & Version $\|$ N$_E$ $\|$ [ENC$_{KeyWrapKey}$(ConfigData) ] $\|$ HMAC$_{AuthKey}$ (M7 $\|$ M8*) 
\\\\

\end{tabular}
\caption{Protocol for joining WPS-enabled WLAN. Modified from~\cite{microsoftWCN}}
\end{figure}


% End of document!
% ------------------------------------------------------------------
% The LastPage package automatically places a label on the last page.
% That works better than placing a label here manually, because the
% label might not go to the actual last page, if LaTeX needs to place
% floats (that is, figures, tables, and such) to the end of the 
% document.
\end{document}
